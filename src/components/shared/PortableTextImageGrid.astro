---
import SanityImage from './SanityImage.astro';

interface ImageItem {
  _type: string;
  _key?: string;
  asset: {
    _ref: string;
    _type: string;
  };
  alt?: string;
  hotspot?: {
    x: number;
    y: number;
    height: number;
    width: number;
  };
  crop?: {
    top: number;
    bottom: number;
    left: number;
    right: number;
  };
}

interface Props {
  node: {
    _type: string;
    _key?: string;
    images: ImageItem[];
    layout: '2-columns' | '3-columns' | '4-columns' | 'masonry';
    gap?: 'small' | 'medium' | 'large';
  };
}

const { node } = Astro.props;
const { images, layout, gap = 'medium' } = node;

const imageCount = images?.length || 0;

const gapClasses = {
  small: 'gap-2',
  medium: 'gap-4',
  large: 'gap-6',
};

// Liczba kolumn dla każdego layoutu
const columnCount: Record<string, number> = {
  '2-columns': 2,
  '3-columns': 3,
  '4-columns': 4,
  'masonry': 3,
};

const cols = columnCount[layout] || 2;
const isMasonry = layout === 'masonry';

const getMasonryClass = (count: number) => {
  if (count === 1) return 'columns-1';
  if (count === 2) return 'columns-1 sm:columns-2';
  return 'columns-1 sm:columns-2 md:columns-3';
};

const layoutClass = isMasonry ? getMasonryClass(imageCount) : '';
---

{isMasonry ? (
  <div class={`image-grid-masonry ${layoutClass} ${gapClasses[gap]}`}>
    {images?.map((image) => (
      <figure class="image-grid-item-masonry">
        <SanityImage
          image={image}
          alt={image.alt || ''}
          widths={[300, 500, 700]}
          sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
        />
      </figure>
    ))}
  </div>
) : (
  <div class={`image-grid cols-${cols} ${gapClasses[gap]}`}>
    {images?.map((image) => (
      <figure class="image-grid-item">
        <SanityImage
          image={image}
          alt={image.alt || ''}
          widths={[300, 500, 700]}
          sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
        />
      </figure>
    ))}
  </div>
)}

<style>
  .image-grid {
    display: flex;
    flex-wrap: wrap;
    margin: 1.5rem 0;
  }

  .image-grid-item {
    margin: 0;
    overflow: hidden;
    border-radius: 0.5rem;
    flex-grow: 1;
    min-width: 200px;
  }

  .image-grid-item :global(img) {
    width: 100%;
    height: 100%;
    object-fit: cover;
    aspect-ratio: 4/3;
  }

  /* Kolumny - bazowa szerokość elementów */
  .cols-2 .image-grid-item {
    flex-basis: calc(50% - 1rem);
  }

  .cols-3 .image-grid-item {
    flex-basis: calc(33.333% - 1rem);
  }

  .cols-4 .image-grid-item {
    flex-basis: calc(25% - 1rem);
  }

  /* Responsywność */
  @media (max-width: 768px) {
    .cols-3 .image-grid-item,
    .cols-4 .image-grid-item {
      flex-basis: calc(50% - 0.5rem);
    }
  }

  @media (max-width: 480px) {
    .cols-2 .image-grid-item,
    .cols-3 .image-grid-item,
    .cols-4 .image-grid-item {
      flex-basis: 100%;
    }
  }

  /* Gap classes */
  .gap-2 {
    gap: 0.5rem;
  }

  .gap-4 {
    gap: 1rem;
  }

  .gap-6 {
    gap: 1.5rem;
  }

  /* Masonry layout */
  .image-grid-masonry {
    margin: 1.5rem 0;
  }

  .image-grid-item-masonry {
    margin: 0;
    overflow: hidden;
    border-radius: 0.5rem;
    break-inside: avoid;
    margin-bottom: 1rem;
  }

  .image-grid-item-masonry :global(img) {
    width: 100%;
    height: auto;
  }

  .image-grid-masonry.gap-2 {
    column-gap: 0.5rem;
  }

  .image-grid-masonry.gap-2 .image-grid-item-masonry {
    margin-bottom: 0.5rem;
  }

  .image-grid-masonry.gap-4 {
    column-gap: 1rem;
  }

  .image-grid-masonry.gap-4 .image-grid-item-masonry {
    margin-bottom: 1rem;
  }

  .image-grid-masonry.gap-6 {
    column-gap: 1.5rem;
  }

  .image-grid-masonry.gap-6 .image-grid-item-masonry {
    margin-bottom: 1.5rem;
  }

  /* Columns for masonry */
  .columns-1 {
    columns: 1;
  }

  @media (min-width: 640px) {
    .sm\:columns-2 {
      columns: 2;
    }
  }

  @media (min-width: 768px) {
    .md\:columns-3 {
      columns: 3;
    }
  }
</style>
